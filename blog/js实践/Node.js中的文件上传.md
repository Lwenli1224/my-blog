# 说说Node.js中的文件上传

在web开发中，文件上传总是一个比较棘手并且容易出错的问题，虽然在前端有各种各样的轮子已经可以很容易地实现上传功能，但是也需要更全面和深入地了解才能更好地使用，并且在实现上传功能的基础上还需要考虑到文件的大小，对于内存的占用，断点续传等各种各样的问题。

在Node.js中，文件上传涉及到两个领域的知识，**HTTP协议**和**流**，以下是重要概念。

## HTTP协议

HTTP应用程序是通过HTTP报文来传递消息，HTTP报文是由起始行、首部和实体组成。如果说HTTP报文是箱子，那么实体则是所运送的货物，而首部就是对货物的说明。

文件上传依然是基于HTTP协议的。文件通过HTTP报文上传到服务器，上传文件的原始内容就是实体的内容，而服务器解析文件，就需要文件的大小、类型及编码方式，所以以下两个首部尤为重要：

- Content-Length：实体长度（编码后）
- Content-Type：实体MIME类型

### 实体大小

需要设置实体大小（Content-Length）首部的意义是通过其检测报文的结尾。HTTP早期是采用关闭连接的方法来作为报文的结束。但关闭连接的方法不够严谨，用户主动结束，网络波动或是服务器崩溃都有可能造成连接关闭，所以无法区分是报文结束正常关闭连接还是异常情况导致的关闭。

当设置了Content-Length后，服务器就可得知报文何时结束，然后正常关闭连接。当且仅档使用分块编码时，可以不设置Content-Length，其他情况下，会认为连接关闭时报文结束。

### 内容编码

### 分块编码

## 流

### 可读流

### 可写流

### HTTP Streamd






